
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/cases/tiledmap/Puzzle.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '6289cZl6zJEcLVQd60JnAzW', 'Puzzle');
// cases/tiledmap/Puzzle.js

"use strict";

var MoveDirection = cc.Enum({
  NONE: 0,
  UP: 1,
  DOWN: 2,
  LEFT: 3,
  RIGHT: 4
});
var minTilesCount = 2;
var mapMoveStep = 1;
var minMoveValue = 50;
cc.Class({
  "extends": cc.Component,
  editor: {
    requireComponent: cc.TiledMap
  },
  properties: {
    _touchStartPos: {
      "default": null,
      serializable: false
    },
    _touching: {
      "default": false,
      serializable: false
    },
    _isMapLoaded: {
      "default": false,
      serializable: false
    },
    floorLayerName: {
      "default": 'floor'
    },
    barrierLayerName: {
      "default": 'barrier'
    },
    objectGroupName: {
      "default": 'players'
    },
    startObjectName: {
      "default": 'SpawnPoint'
    },
    successObjectName: {
      "default": 'SuccessPoint'
    }
  },
  // use this for initialization
  onLoad: function onLoad() {
    var _this = this;

    this._player = this.node.getChildByName('player');

    if (!this._isMapLoaded) {
      this._player.active = false;
    }

    cc.systemEvent.on(cc.SystemEvent.EventType.KEY_UP, this._onKeyPressed, this);
    this.node.on(cc.Node.EventType.TOUCH_START, function (event) {
      _this._touching = true;
      _this._touchStartPos = event.touch.getLocation();
    });
    this.node.on(cc.Node.EventType.TOUCH_END, function (event) {
      if (!_this._touching || !_this._isMapLoaded || _this._succeedLayer.active) return;
      _this._touching = false;
      var touchPos = event.touch.getLocation();
      var movedX = touchPos.x - _this._touchStartPos.x;
      var movedY = touchPos.y - _this._touchStartPos.y;
      var movedXValue = Math.abs(movedX);
      var movedYValue = Math.abs(movedY);

      if (movedXValue < minMoveValue && movedYValue < minMoveValue) {
        // touch moved not enough
        return;
      }

      var newTile = cc.v2(_this._curTile.x, _this._curTile.y);
      var mapMoveDir = MoveDirection.NONE;

      if (movedXValue >= movedYValue) {
        // move to right or left
        if (movedX > 0) {
          newTile.x += 1;
          mapMoveDir = MoveDirection.LEFT;
        } else {
          newTile.x -= 1;
          mapMoveDir = MoveDirection.RIGHT;
        }
      } else {
        // move to up or down
        if (movedY > 0) {
          newTile.y -= 1;
          mapMoveDir = MoveDirection.DOWN;
        } else {
          newTile.y += 1;
          mapMoveDir = MoveDirection.UP;
        }
      }

      _this._tryMoveToNewTile(newTile, mapMoveDir);
    });
  },
  onDestroy: function onDestroy() {
    cc.systemEvent.off(cc.SystemEvent.EventType.KEY_UP, this._onKeyPressed, this);
  },
  restartGame: function restartGame() {
    this._succeedLayer.active = false;

    this._initMapPos();

    this._curTile = this._startTile;

    this._updatePlayerPos();
  },
  start: function start(err) {
    if (err) return; // init the map position

    this._initMapPos(); // init the succeed layer


    this._succeedLayer = this.node.getParent().getChildByName('succeedLayer');
    this._succeedLayer.active = false; // init the player position

    this._tiledMap = this.node.getComponent('cc.TiledMap');

    var objectGroup = this._tiledMap.getObjectGroup(this.objectGroupName);

    if (!objectGroup) return;
    var startObj = objectGroup.getObject(this.startObjectName);
    var endObj = objectGroup.getObject(this.successObjectName);
    if (!startObj || !endObj) return;
    var startPos = cc.v2(startObj.x, startObj.y);
    var endPos = cc.v2(endObj.x, endObj.y);
    this._layerFloor = this._tiledMap.getLayer(this.floorLayerName);
    this._layerBarrier = this._tiledMap.getLayer(this.barrierLayerName);
    if (!this._layerFloor || !this._layerBarrier) return;
    this._curTile = this._startTile = this._getTilePos(startPos);
    this._endTile = this._getTilePos(endPos);

    if (this._player) {
      this._updatePlayerPos();

      this._player.active = true;
    }

    this._isMapLoaded = true;
  },
  _initMapPos: function _initMapPos() {
    this.node.setPosition(cc.visibleRect.bottomLeft);
  },
  _updatePlayerPos: function _updatePlayerPos() {
    var pos = this._layerFloor.getPositionAt(this._curTile);

    this._player.setPosition(pos);
  },
  _getTilePos: function _getTilePos(posInPixel) {
    var mapSize = this.node.getContentSize();

    var tileSize = this._tiledMap.getTileSize();

    var x = Math.floor(posInPixel.x / tileSize.width);
    var y = Math.floor((mapSize.height - posInPixel.y) / tileSize.height);
    return cc.v2(x, y);
  },
  _onKeyPressed: function _onKeyPressed(event) {
    if (!this._isMapLoaded || this._succeedLayer.active) return;
    var newTile = cc.v2(this._curTile.x, this._curTile.y);
    var mapMoveDir = MoveDirection.NONE;

    switch (event.keyCode) {
      case cc.macro.KEY.up:
        newTile.y -= 1;
        mapMoveDir = MoveDirection.DOWN;
        break;

      case cc.macro.KEY.down:
        newTile.y += 1;
        mapMoveDir = MoveDirection.UP;
        break;

      case cc.macro.KEY.left:
        newTile.x -= 1;
        mapMoveDir = MoveDirection.RIGHT;
        break;

      case cc.macro.KEY.right:
        newTile.x += 1;
        mapMoveDir = MoveDirection.LEFT;
        break;

      default:
        return;
    }

    this._tryMoveToNewTile(newTile, mapMoveDir);
  },
  _tryMoveToNewTile: function _tryMoveToNewTile(newTile, mapMoveDir) {
    var mapSize = this._tiledMap.getMapSize();

    if (newTile.x < 0 || newTile.x >= mapSize.width) return;
    if (newTile.y < 0 || newTile.y >= mapSize.height) return;

    if (this._layerBarrier.getTileGIDAt(newTile)) {
      cc.log('This way is blocked!');
      return false;
    } // update the player position


    this._curTile = newTile;

    this._updatePlayerPos(); // move the map if necessary


    this._tryMoveMap(mapMoveDir); // check the player is success or not


    if (this._curTile.equals(this._endTile)) {
      cc.log('succeed');
      this._succeedLayer.active = true;
    }
  },
  _tryMoveMap: function _tryMoveMap(moveDir) {
    // get necessary data
    var mapContentSize = this.node.getContentSize();
    var mapPos = this.node.getPosition();

    var playerPos = this._player.getPosition();

    var viewSize = cc.size(cc.visibleRect.width, cc.visibleRect.height);

    var tileSize = this._tiledMap.getTileSize();

    var minDisX = minTilesCount * tileSize.width;
    var minDisY = minTilesCount * tileSize.height;
    var disX = playerPos.x + mapPos.x;
    var disY = playerPos.y + mapPos.y;
    var newPos;

    switch (moveDir) {
      case MoveDirection.UP:
        if (disY < minDisY) {
          newPos = cc.v2(mapPos.x, mapPos.y + tileSize.height * mapMoveStep);
        }

        break;

      case MoveDirection.DOWN:
        if (viewSize.height - disY - tileSize.height < minDisY) {
          newPos = cc.v2(mapPos.x, mapPos.y - tileSize.height * mapMoveStep);
        }

        break;

      case MoveDirection.LEFT:
        if (viewSize.width - disX - tileSize.width < minDisX) {
          newPos = cc.v2(mapPos.x - tileSize.width * mapMoveStep, mapPos.y);
        }

        break;

      case MoveDirection.RIGHT:
        if (disX < minDisX) {
          newPos = cc.v2(mapPos.x + tileSize.width * mapMoveStep, mapPos.y);
        }

        break;

      default:
        return;
    }

    if (newPos) {
      // calculate the position range of map
      var minX = viewSize.width - mapContentSize.width - cc.visibleRect.left;
      var maxX = cc.visibleRect.left.x;
      var minY = viewSize.height - mapContentSize.height - cc.visibleRect.bottom;
      var maxY = cc.visibleRect.bottom.y;
      if (newPos.x < minX) newPos.x = minX;
      if (newPos.x > maxX) newPos.x = maxX;
      if (newPos.y < minY) newPos.y = minY;
      if (newPos.y > maxY) newPos.y = maxY;

      if (!newPos.equals(mapPos)) {
        cc.log('Move the map to new position: ', newPos);
        this.node.setPosition(newPos);
      }
    }
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9jYXNlcy90aWxlZG1hcC9QdXp6bGUuanMiXSwibmFtZXMiOlsiTW92ZURpcmVjdGlvbiIsImNjIiwiRW51bSIsIk5PTkUiLCJVUCIsIkRPV04iLCJMRUZUIiwiUklHSFQiLCJtaW5UaWxlc0NvdW50IiwibWFwTW92ZVN0ZXAiLCJtaW5Nb3ZlVmFsdWUiLCJDbGFzcyIsIkNvbXBvbmVudCIsImVkaXRvciIsInJlcXVpcmVDb21wb25lbnQiLCJUaWxlZE1hcCIsInByb3BlcnRpZXMiLCJfdG91Y2hTdGFydFBvcyIsInNlcmlhbGl6YWJsZSIsIl90b3VjaGluZyIsIl9pc01hcExvYWRlZCIsImZsb29yTGF5ZXJOYW1lIiwiYmFycmllckxheWVyTmFtZSIsIm9iamVjdEdyb3VwTmFtZSIsInN0YXJ0T2JqZWN0TmFtZSIsInN1Y2Nlc3NPYmplY3ROYW1lIiwib25Mb2FkIiwiX3BsYXllciIsIm5vZGUiLCJnZXRDaGlsZEJ5TmFtZSIsImFjdGl2ZSIsInN5c3RlbUV2ZW50Iiwib24iLCJTeXN0ZW1FdmVudCIsIkV2ZW50VHlwZSIsIktFWV9VUCIsIl9vbktleVByZXNzZWQiLCJOb2RlIiwiVE9VQ0hfU1RBUlQiLCJldmVudCIsInRvdWNoIiwiZ2V0TG9jYXRpb24iLCJUT1VDSF9FTkQiLCJfc3VjY2VlZExheWVyIiwidG91Y2hQb3MiLCJtb3ZlZFgiLCJ4IiwibW92ZWRZIiwieSIsIm1vdmVkWFZhbHVlIiwiTWF0aCIsImFicyIsIm1vdmVkWVZhbHVlIiwibmV3VGlsZSIsInYyIiwiX2N1clRpbGUiLCJtYXBNb3ZlRGlyIiwiX3RyeU1vdmVUb05ld1RpbGUiLCJvbkRlc3Ryb3kiLCJvZmYiLCJyZXN0YXJ0R2FtZSIsIl9pbml0TWFwUG9zIiwiX3N0YXJ0VGlsZSIsIl91cGRhdGVQbGF5ZXJQb3MiLCJzdGFydCIsImVyciIsImdldFBhcmVudCIsIl90aWxlZE1hcCIsImdldENvbXBvbmVudCIsIm9iamVjdEdyb3VwIiwiZ2V0T2JqZWN0R3JvdXAiLCJzdGFydE9iaiIsImdldE9iamVjdCIsImVuZE9iaiIsInN0YXJ0UG9zIiwiZW5kUG9zIiwiX2xheWVyRmxvb3IiLCJnZXRMYXllciIsIl9sYXllckJhcnJpZXIiLCJfZ2V0VGlsZVBvcyIsIl9lbmRUaWxlIiwic2V0UG9zaXRpb24iLCJ2aXNpYmxlUmVjdCIsImJvdHRvbUxlZnQiLCJwb3MiLCJnZXRQb3NpdGlvbkF0IiwicG9zSW5QaXhlbCIsIm1hcFNpemUiLCJnZXRDb250ZW50U2l6ZSIsInRpbGVTaXplIiwiZ2V0VGlsZVNpemUiLCJmbG9vciIsIndpZHRoIiwiaGVpZ2h0Iiwia2V5Q29kZSIsIm1hY3JvIiwiS0VZIiwidXAiLCJkb3duIiwibGVmdCIsInJpZ2h0IiwiZ2V0TWFwU2l6ZSIsImdldFRpbGVHSURBdCIsImxvZyIsIl90cnlNb3ZlTWFwIiwiZXF1YWxzIiwibW92ZURpciIsIm1hcENvbnRlbnRTaXplIiwibWFwUG9zIiwiZ2V0UG9zaXRpb24iLCJwbGF5ZXJQb3MiLCJ2aWV3U2l6ZSIsInNpemUiLCJtaW5EaXNYIiwibWluRGlzWSIsImRpc1giLCJkaXNZIiwibmV3UG9zIiwibWluWCIsIm1heFgiLCJtaW5ZIiwiYm90dG9tIiwibWF4WSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFJQSxhQUFhLEdBQUdDLEVBQUUsQ0FBQ0MsSUFBSCxDQUFRO0VBQ3hCQyxJQUFJLEVBQUUsQ0FEa0I7RUFFeEJDLEVBQUUsRUFBRSxDQUZvQjtFQUd4QkMsSUFBSSxFQUFFLENBSGtCO0VBSXhCQyxJQUFJLEVBQUUsQ0FKa0I7RUFLeEJDLEtBQUssRUFBRTtBQUxpQixDQUFSLENBQXBCO0FBUUEsSUFBSUMsYUFBYSxHQUFHLENBQXBCO0FBQ0EsSUFBSUMsV0FBVyxHQUFHLENBQWxCO0FBQ0EsSUFBSUMsWUFBWSxHQUFHLEVBQW5CO0FBRUFULEVBQUUsQ0FBQ1UsS0FBSCxDQUFTO0VBQ0wsV0FBU1YsRUFBRSxDQUFDVyxTQURQO0VBRUxDLE1BQU0sRUFBRTtJQUNKQyxnQkFBZ0Is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QVcwRSxJQUFmLEVBQXFCTCxNQUFNLENBQUNyRSxDQUFQLEdBQVcwRSxJQUFYOztNQUVyQixJQUFJLENBQUNMLE1BQU0sQ0FBQ1osTUFBUCxDQUFjRyxNQUFkLENBQUwsRUFBNEI7UUFDeEIzRyxFQUFFLENBQUNzRyxHQUFILENBQU8sZ0NBQVAsRUFBeUNjLE1BQXpDO1FBQ0EsS0FBS3pGLElBQUwsQ0FBVXFELFdBQVYsQ0FBc0JvQyxNQUF0QjtNQUNIO0lBQ0o7RUFDSjtBQTVRSSxDQUFUIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgTW92ZURpcmVjdGlvbiA9IGNjLkVudW0oe1xuICAgIE5PTkU6IDAsXG4gICAgVVA6IDEsXG4gICAgRE9XTjogMixcbiAgICBMRUZUOiAzLFxuICAgIFJJR0hUOiA0XG59KTtcblxudmFyIG1pblRpbGVzQ291bnQgPSAyO1xudmFyIG1hcE1vdmVTdGVwID0gMTtcbnZhciBtaW5Nb3ZlVmFsdWUgPSA1MDtcblxuY2MuQ2xhc3Moe1xuICAgIGV4dGVuZHM6IGNjLkNvbXBvbmVudCxcbiAgICBlZGl0b3I6IHtcbiAgICAgICAgcmVxdWlyZUNvbXBvbmVudDogY2MuVGlsZWRNYXBcbiAgICB9LFxuXG4gICAgcHJvcGVydGllczoge1xuICAgICAgICBfdG91Y2hTdGFydFBvczoge1xuICAgICAgICAgICAgZGVmYXVsdDogbnVsbCxcbiAgICAgICAgICAgIHNlcmlhbGl6YWJsZTogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIF90b3VjaGluZzoge1xuICAgICAgICAgICAgZGVmYXVsdDogZmFsc2UsXG4gICAgICAgICAgICBzZXJpYWxpemFibGU6IGZhbHNlLFxuICAgICAgICB9LFxuXG4gICAgICAgIF9pc01hcExvYWRlZCA6IHtcbiAgICAgICAgICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgICAgICAgICAgc2VyaWFsaXphYmxlOiBmYWxzZSxcbiAgICAgICAgfSxcblxuICAgICAgICBmbG9vckxheWVyTmFtZToge1xuICAgICAgICAgICAgZGVmYXVsdDogJ2Zsb29yJ1xuICAgICAgICB9LFxuXG4gICAgICAgIGJhcnJpZXJMYXllck5hbWU6IHtcbiAgICAgICAgICAgIGRlZmF1bHQ6ICdiYXJyaWVyJ1xuICAgICAgICB9LFxuXG4gICAgICAgIG9iamVjdEdyb3VwTmFtZToge1xuICAgICAgICAgICAgZGVmYXVsdDogJ3BsYXllcnMnXG4gICAgICAgIH0sXG5cbiAgICAgICAgc3RhcnRPYmplY3ROYW1lOiB7XG4gICAgICAgICAgICBkZWZhdWx0OidTcGF3blBvaW50J1xuICAgICAgICB9LFxuXG4gICAgICAgIHN1Y2Nlc3NPYmplY3ROYW1lOiB7XG4gICAgICAgICAgICBkZWZhdWx0OidTdWNjZXNzUG9pbnQnXG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLy8gdXNlIHRoaXMgZm9yIGluaXRpYWxpemF0aW9uXG4gICAgb25Mb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuX3BsYXllciA9IHRoaXMubm9kZS5nZXRDaGlsZEJ5TmFtZSgncGxheWVyJyk7XG4gICAgICAgIGlmICghIHRoaXMuX2lzTWFwTG9hZGVkKSB7XG4gICAgICAgICAgICB0aGlzLl9wbGF5ZXIuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjYy5zeXN0ZW1FdmVudC5vbihjYy5TeXN0ZW1FdmVudC5FdmVudFR5cGUuS0VZX1VQLCB0aGlzLl9vbktleVByZXNzZWQsIHRoaXMpO1xuXG4gICAgICAgIHRoaXMubm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9TVEFSVCwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLl90b3VjaGluZyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLl90b3VjaFN0YXJ0UG9zID0gZXZlbnQudG91Y2guZ2V0TG9jYXRpb24oKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9FTkQsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLl90b3VjaGluZyB8fCAhdGhpcy5faXNNYXBMb2FkZWQgfHwgdGhpcy5fc3VjY2VlZExheWVyLmFjdGl2ZSkgcmV0dXJuO1xuXG4gICAgICAgICAgICB0aGlzLl90b3VjaGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgdmFyIHRvdWNoUG9zID0gZXZlbnQudG91Y2guZ2V0TG9jYXRpb24oKTtcbiAgICAgICAgICAgIHZhciBtb3ZlZFggPSB0b3VjaFBvcy54IC0gdGhpcy5fdG91Y2hTdGFydFBvcy54O1xuICAgICAgICAgICAgdmFyIG1vdmVkWSA9IHRvdWNoUG9zLnkgLSB0aGlzLl90b3VjaFN0YXJ0UG9zLnk7XG4gICAgICAgICAgICB2YXIgbW92ZWRYVmFsdWUgPSBNYXRoLmFicyhtb3ZlZFgpO1xuICAgICAgICAgICAgdmFyIG1vdmVkWVZhbHVlID0gTWF0aC5hYnMobW92ZWRZKTtcbiAgICAgICAgICAgIGlmIChtb3ZlZFhWYWx1ZSA8IG1pbk1vdmVWYWx1ZSAmJiBtb3ZlZFlWYWx1ZSA8IG1pbk1vdmVWYWx1ZSkge1xuICAgICAgICAgICAgICAgIC8vIHRvdWNoIG1vdmVkIG5vdCBlbm91Z2hcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBuZXdUaWxlID0gY2MudjIodGhpcy5fY3VyVGlsZS54LCB0aGlzLl9jdXJUaWxlLnkpO1xuICAgICAgICAgICAgdmFyIG1hcE1vdmVEaXIgPSBNb3ZlRGlyZWN0aW9uLk5PTkU7XG4gICAgICAgICAgICBpZiAobW92ZWRYVmFsdWUgPj0gbW92ZWRZVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIHRvIHJpZ2h0IG9yIGxlZnRcbiAgICAgICAgICAgICAgICBpZiAobW92ZWRYID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBuZXdUaWxlLnggKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbWFwTW92ZURpciA9IE1vdmVEaXJlY3Rpb24uTEVGVDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdUaWxlLnggLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgbWFwTW92ZURpciA9IE1vdmVEaXJlY3Rpb24uUklHSFQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIHRvIHVwIG9yIGRvd25cbiAgICAgICAgICAgICAgICBpZiAobW92ZWRZID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBuZXdUaWxlLnkgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgbWFwTW92ZURpciA9IE1vdmVEaXJlY3Rpb24uRE9XTjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdUaWxlLnkgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbWFwTW92ZURpciA9IE1vdmVEaXJlY3Rpb24uVVA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fdHJ5TW92ZVRvTmV3VGlsZShuZXdUaWxlLCBtYXBNb3ZlRGlyKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIG9uRGVzdHJveSAoKSB7XG4gICAgICAgIGNjLnN5c3RlbUV2ZW50Lm9mZihjYy5TeXN0ZW1FdmVudC5FdmVudFR5cGUuS0VZX1VQLCB0aGlzLl9vbktleVByZXNzZWQsIHRoaXMpO1xuICAgIH0sXG5cbiAgICByZXN0YXJ0R2FtZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuX3N1Y2NlZWRMYXllci5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5faW5pdE1hcFBvcygpO1xuICAgICAgICB0aGlzLl9jdXJUaWxlID0gdGhpcy5fc3RhcnRUaWxlO1xuICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJQb3MoKTtcbiAgICB9LFxuXG4gICAgc3RhcnQ6IGZ1bmN0aW9uKGVycikge1xuICAgICAgICBpZiAoZXJyKSByZXR1cm47XG5cbiAgICAgICAgLy8gaW5pdCB0aGUgbWFwIHBvc2l0aW9uXG4gICAgICAgIHRoaXMuX2luaXRNYXBQb3MoKTtcblxuICAgICAgICAvLyBpbml0IHRoZSBzdWNjZWVkIGxheWVyXG4gICAgICAgIHRoaXMuX3N1Y2NlZWRMYXllciA9IHRoaXMubm9kZS5nZXRQYXJlbnQoKS5nZXRDaGlsZEJ5TmFtZSgnc3VjY2VlZExheWVyJyk7XG4gICAgICAgIHRoaXMuX3N1Y2NlZWRMYXllci5hY3RpdmUgPSBmYWxzZTtcblxuICAgICAgICAvLyBpbml0IHRoZSBwbGF5ZXIgcG9zaXRpb25cbiAgICAgICAgdGhpcy5fdGlsZWRNYXAgPSB0aGlzLm5vZGUuZ2V0Q29tcG9uZW50KCdjYy5UaWxlZE1hcCcpO1xuICAgICAgICB2YXIgb2JqZWN0R3JvdXAgPSB0aGlzLl90aWxlZE1hcC5nZXRPYmplY3RHcm91cCh0aGlzLm9iamVjdEdyb3VwTmFtZSk7XG4gICAgICAgIGlmICghb2JqZWN0R3JvdXApIHJldHVybjtcblxuICAgICAgICB2YXIgc3RhcnRPYmogPSBvYmplY3RHcm91cC5nZXRPYmplY3QodGhpcy5zdGFydE9iamVjdE5hbWUpO1xuICAgICAgICB2YXIgZW5kT2JqID0gb2JqZWN0R3JvdXAuZ2V0T2JqZWN0KHRoaXMuc3VjY2Vzc09iamVjdE5hbWUpO1xuICAgICAgICBpZiAoIXN0YXJ0T2JqIHx8ICFlbmRPYmopIHJldHVybjtcblxuICAgICAgICB2YXIgc3RhcnRQb3MgPSBjYy52MihzdGFydE9iai54LCBzdGFydE9iai55KTtcbiAgICAgICAgdmFyIGVuZFBvcyA9IGNjLnYyKGVuZE9iai54LCBlbmRPYmoueSk7XG5cbiAgICAgICAgdGhpcy5fbGF5ZXJGbG9vciA9IHRoaXMuX3RpbGVkTWFwLmdldExheWVyKHRoaXMuZmxvb3JMYXllck5hbWUpO1xuICAgICAgICB0aGlzLl9sYXllckJhcnJpZXIgPSB0aGlzLl90aWxlZE1hcC5nZXRMYXllcih0aGlzLmJhcnJpZXJMYXllck5hbWUpO1xuICAgICAgICBpZiAoIXRoaXMuX2xheWVyRmxvb3IgfHwgIXRoaXMuX2xheWVyQmFycmllcikgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuX2N1clRpbGUgPSB0aGlzLl9zdGFydFRpbGUgPSB0aGlzLl9nZXRUaWxlUG9zKHN0YXJ0UG9zKTtcbiAgICAgICAgdGhpcy5fZW5kVGlsZSA9IHRoaXMuX2dldFRpbGVQb3MoZW5kUG9zKTtcblxuICAgICAgICBpZiAodGhpcy5fcGxheWVyKSB7XG4gICAgICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJQb3MoKTtcbiAgICAgICAgICAgIHRoaXMuX3BsYXllci5hY3RpdmUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faXNNYXBMb2FkZWQgPSB0cnVlO1xuICAgIH0sXG5cbiAgICBfaW5pdE1hcFBvczogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubm9kZS5zZXRQb3NpdGlvbihjYy52aXNpYmxlUmVjdC5ib3R0b21MZWZ0KTtcbiAgICB9LFxuXG4gICAgX3VwZGF0ZVBsYXllclBvczogZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBwb3MgPSB0aGlzLl9sYXllckZsb29yLmdldFBvc2l0aW9uQXQodGhpcy5fY3VyVGlsZSk7XG4gICAgICAgIHRoaXMuX3BsYXllci5zZXRQb3NpdGlvbihwb3MpO1xuICAgIH0sXG5cbiAgICBfZ2V0VGlsZVBvczogZnVuY3Rpb24ocG9zSW5QaXhlbCkge1xuICAgICAgICB2YXIgbWFwU2l6ZSA9IHRoaXMubm9kZS5nZXRDb250ZW50U2l6ZSgpO1xuICAgICAgICB2YXIgdGlsZVNpemUgPSB0aGlzLl90aWxlZE1hcC5nZXRUaWxlU2l6ZSgpO1xuICAgICAgICB2YXIgeCA9IE1hdGguZmxvb3IocG9zSW5QaXhlbC54IC8gdGlsZVNpemUud2lkdGgpO1xuICAgICAgICB2YXIgeSA9IE1hdGguZmxvb3IoKG1hcFNpemUuaGVpZ2h0IC0gcG9zSW5QaXhlbC55KSAvIHRpbGVTaXplLmhlaWdodCk7XG5cbiAgICAgICAgcmV0dXJuIGNjLnYyKHgsIHkpO1xuICAgIH0sXG5cbiAgICBfb25LZXlQcmVzc2VkOiBmdW5jdGlvbihldmVudCkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzTWFwTG9hZGVkIHx8IHRoaXMuX3N1Y2NlZWRMYXllci5hY3RpdmUpIHJldHVybjtcblxuICAgICAgICB2YXIgbmV3VGlsZSA9IGNjLnYyKHRoaXMuX2N1clRpbGUueCwgdGhpcy5fY3VyVGlsZS55KTtcbiAgICAgICAgdmFyIG1hcE1vdmVEaXIgPSBNb3ZlRGlyZWN0aW9uLk5PTkU7XG4gICAgICAgIHN3aXRjaChldmVudC5rZXlDb2RlKSB7XG4gICAgICAgICAgICBjYXNlIGNjLm1hY3JvLktFWS51cDpcbiAgICAgICAgICAgICAgICBuZXdUaWxlLnkgLT0gMTtcbiAgICAgICAgICAgICAgICBtYXBNb3ZlRGlyID0gTW92ZURpcmVjdGlvbi5ET1dOO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBjYy5tYWNyby5LRVkuZG93bjpcbiAgICAgICAgICAgICAgICBuZXdUaWxlLnkgKz0gMTtcbiAgICAgICAgICAgICAgICBtYXBNb3ZlRGlyID0gTW92ZURpcmVjdGlvbi5VUDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgY2MubWFjcm8uS0VZLmxlZnQ6XG4gICAgICAgICAgICAgICAgbmV3VGlsZS54IC09IDE7XG4gICAgICAgICAgICAgICAgbWFwTW92ZURpciA9IE1vdmVEaXJlY3Rpb24uUklHSFQ7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGNjLm1hY3JvLktFWS5yaWdodDpcbiAgICAgICAgICAgICAgICBuZXdUaWxlLnggKz0gMTtcbiAgICAgICAgICAgICAgICBtYXBNb3ZlRGlyID0gTW92ZURpcmVjdGlvbi5MRUZUO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl90cnlNb3ZlVG9OZXdUaWxlKG5ld1RpbGUsIG1hcE1vdmVEaXIpO1xuICAgIH0sXG5cbiAgICBfdHJ5TW92ZVRvTmV3VGlsZTogZnVuY3Rpb24obmV3VGlsZSwgbWFwTW92ZURpcikge1xuICAgICAgICB2YXIgbWFwU2l6ZSA9IHRoaXMuX3RpbGVkTWFwLmdldE1hcFNpemUoKTtcbiAgICAgICAgaWYgKG5ld1RpbGUueCA8IDAgfHwgbmV3VGlsZS54ID49IG1hcFNpemUud2lkdGgpIHJldHVybjtcbiAgICAgICAgaWYgKG5ld1RpbGUueSA8IDAgfHwgbmV3VGlsZS55ID49IG1hcFNpemUuaGVpZ2h0KSByZXR1cm47XG5cbiAgICAgICAgaWYgKHRoaXMuX2xheWVyQmFycmllci5nZXRUaWxlR0lEQXQobmV3VGlsZSkpIHtcbiAgICAgICAgICAgIGNjLmxvZygnVGhpcyB3YXkgaXMgYmxvY2tlZCEnKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHVwZGF0ZSB0aGUgcGxheWVyIHBvc2l0aW9uXG4gICAgICAgIHRoaXMuX2N1clRpbGUgPSBuZXdUaWxlO1xuICAgICAgICB0aGlzLl91cGRhdGVQbGF5ZXJQb3MoKTtcblxuICAgICAgICAvLyBtb3ZlIHRoZSBtYXAgaWYgbmVjZXNzYXJ5XG4gICAgICAgIHRoaXMuX3RyeU1vdmVNYXAobWFwTW92ZURpcik7XG5cbiAgICAgICAgLy8gY2hlY2sgdGhlIHBsYXllciBpcyBzdWNjZXNzIG9yIG5vdFxuICAgICAgICBpZiAodGhpcy5fY3VyVGlsZS5lcXVhbHModGhpcy5fZW5kVGlsZSkpIHtcbiAgICAgICAgICAgIGNjLmxvZygnc3VjY2VlZCcpO1xuICAgICAgICAgICAgdGhpcy5fc3VjY2VlZExheWVyLmFjdGl2ZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX3RyeU1vdmVNYXA6IGZ1bmN0aW9uKG1vdmVEaXIpIHtcbiAgICAgICAgLy8gZ2V0IG5lY2Vzc2FyeSBkYXRhXG4gICAgICAgIHZhciBtYXBDb250ZW50U2l6ZSA9IHRoaXMubm9kZS5nZXRDb250ZW50U2l6ZSgpO1xuICAgICAgICB2YXIgbWFwUG9zID0gdGhpcy5ub2RlLmdldFBvc2l0aW9uKCk7XG4gICAgICAgIHZhciBwbGF5ZXJQb3MgPSB0aGlzLl9wbGF5ZXIuZ2V0UG9zaXRpb24oKTtcbiAgICAgICAgdmFyIHZpZXdTaXplID0gY2Muc2l6ZShjYy52aXNpYmxlUmVjdC53aWR0aCwgY2MudmlzaWJsZVJlY3QuaGVpZ2h0KTtcbiAgICAgICAgdmFyIHRpbGVTaXplID0gdGhpcy5fdGlsZWRNYXAuZ2V0VGlsZVNpemUoKTtcbiAgICAgICAgdmFyIG1pbkRpc1ggPSBtaW5UaWxlc0NvdW50ICogdGlsZVNpemUud2lkdGg7XG4gICAgICAgIHZhciBtaW5EaXNZID0gbWluVGlsZXNDb3VudCAqIHRpbGVTaXplLmhlaWdodDtcblxuICAgICAgICB2YXIgZGlzWCA9IHBsYXllclBvcy54ICsgbWFwUG9zLng7XG4gICAgICAgIHZhciBkaXNZID0gcGxheWVyUG9zLnkgKyBtYXBQb3MueTtcbiAgICAgICAgdmFyIG5ld1BvcztcbiAgICAgICAgc3dpdGNoIChtb3ZlRGlyKSB7XG4gICAgICAgICAgICBjYXNlIE1vdmVEaXJlY3Rpb24uVVA6XG4gICAgICAgICAgICAgICAgaWYgKGRpc1kgPCBtaW5EaXNZKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld1BvcyA9IGNjLnYyKG1hcFBvcy54LCBtYXBQb3MueSArIHRpbGVTaXplLmhlaWdodCAqIG1hcE1vdmVTdGVwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIE1vdmVEaXJlY3Rpb24uRE9XTjpcbiAgICAgICAgICAgICAgICBpZiAodmlld1NpemUuaGVpZ2h0IC0gZGlzWSAtIHRpbGVTaXplLmhlaWdodCA8IG1pbkRpc1kpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3UG9zID0gY2MudjIobWFwUG9zLngsIG1hcFBvcy55IC0gdGlsZVNpemUuaGVpZ2h0ICogbWFwTW92ZVN0ZXApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgTW92ZURpcmVjdGlvbi5MRUZUOlxuICAgICAgICAgICAgICAgIGlmICh2aWV3U2l6ZS53aWR0aCAtIGRpc1ggLSB0aWxlU2l6ZS53aWR0aCA8IG1pbkRpc1gpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3UG9zID0gY2MudjIobWFwUG9zLnggLSB0aWxlU2l6ZS53aWR0aCAqIG1hcE1vdmVTdGVwLCBtYXBQb3MueSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBNb3ZlRGlyZWN0aW9uLlJJR0hUOlxuICAgICAgICAgICAgICAgIGlmIChkaXNYIDwgbWluRGlzWCkge1xuICAgICAgICAgICAgICAgICAgICBuZXdQb3MgPSBjYy52MihtYXBQb3MueCArIHRpbGVTaXplLndpZHRoICogbWFwTW92ZVN0ZXAsIG1hcFBvcy55KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuZXdQb3MpIHtcbiAgICAgICAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgcG9zaXRpb24gcmFuZ2Ugb2YgbWFwXG4gICAgICAgICAgICB2YXIgbWluWCA9IHZpZXdTaXplLndpZHRoIC0gbWFwQ29udGVudFNpemUud2lkdGggLSBjYy52aXNpYmxlUmVjdC5sZWZ0O1xuICAgICAgICAgICAgdmFyIG1heFggPSBjYy52aXNpYmxlUmVjdC5sZWZ0Lng7XG4gICAgICAgICAgICB2YXIgbWluWSA9IHZpZXdTaXplLmhlaWdodCAtIG1hcENvbnRlbnRTaXplLmhlaWdodCAtIGNjLnZpc2libGVSZWN0LmJvdHRvbTtcbiAgICAgICAgICAgIHZhciBtYXhZID0gY2MudmlzaWJsZVJlY3QuYm90dG9tLnk7XG5cbiAgICAgICAgICAgIGlmIChuZXdQb3MueCA8IG1pblgpIG5ld1Bvcy54ID0gbWluWDtcbiAgICAgICAgICAgIGlmIChuZXdQb3MueCA+IG1heFgpIG5ld1Bvcy54ID0gbWF4WDtcbiAgICAgICAgICAgIGlmIChuZXdQb3MueSA8IG1pblkpIG5ld1Bvcy55ID0gbWluWTtcbiAgICAgICAgICAgIGlmIChuZXdQb3MueSA+IG1heFkpIG5ld1Bvcy55ID0gbWF4WTtcblxuICAgICAgICAgICAgaWYgKCFuZXdQb3MuZXF1YWxzKG1hcFBvcykpIHtcbiAgICAgICAgICAgICAgICBjYy5sb2coJ01vdmUgdGhlIG1hcCB0byBuZXcgcG9zaXRpb246ICcsIG5ld1Bvcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5ub2RlLnNldFBvc2l0aW9uKG5ld1Bvcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59KTtcbiJdfQ==

                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/Global/SceneList.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '473b8wxs55OsJvoxVdYCzTF', 'SceneList');
// scripts/Global/SceneList.js

"use strict";

var TipsManager = require('TipsManager');

var SceneList = cc.Class({
  "extends": cc.Component,
  properties: {
    itemPrefab: {
      "default": null,
      type: cc.Prefab
    },
    initItemCount: 0,
    scrollView: cc.ScrollView,
    bufferZone: 0,
    // when item is away from bufferZone, we relocate it
    searchBlock: cc.Node
  },
  createItem: function createItem(x, y, name, url) {
    var item = cc.instantiate(this.itemPrefab);
    var itemComp = item.getComponent('ListItem');
    var label = itemComp.label;
    label.string = name;

    if (url) {
      itemComp.url = url;
    } // item.width = w;


    item.x = x;
    item.y = y;
    this.node.addChild(item);
    return item;
  },
  init: function init(menu) {
    this.menu = menu;
    this.sceneList = [];
    this.itemList = [];
    this.updateTimer = 0;
    this.updateInterval = 0.2;
    this.lastContentPosY = 0; // use this variable to detect if we are scrolling up or down

    TipsManager.init();
    this.initList();
  },
  // use this for initialization
  initList: function initList() {
    var scenes = cc.game._sceneInfos;
    var dict = {};

    if (scenes) {
      for (var i = 0; i < scenes.length; ++i) {
        var url = scenes[i].url;

        if (!url.startsWith('db://assets/cases/')) {
          continue;
        }

        var dirname = cc.path.dirname(url).replace('db://assets/cases/', '');
        var scenename = cc.path.basename(url, '.fire');
        if (!dirname) dirname = '_root';

        if (!dict[dirname]) {
          dict[dirname] = {};
        }

        dict[dirname][scenename] = url;
      }
    } else {
      cc.error('failed to get scene list!');
    } // compile scene dict to an array


    var dirs = Object.keys(dict);
    dirs.sort();

    for (var _i = 0; _i < dirs.length; ++_i) {
      this.sceneList.push({
        name: dirs[_i],
        url: null
      });
      var scenenames = Object.keys(dict[dirs[_i]]);
      scenenames.sort();

      for (var j = 0; j < scenenames.length; ++j) {
        var name = scenenames[j];
        var _url = dict[dirs[_i]][name];
        this.sceneList.push({
          name: name,
          url: _url
        });
      }
    }

    var y = 0;
    this.node.height = (this.sceneList.length + 1) * 50;
    var initItemCount = Math.min(this.initItemCount, this.sceneList.length);

    for (var _i2 = 0; _i2 < initItemCount; ++_i2) {
      var item = cc.instantiate(this.itemPrefab).getComponent('ListItem');
      var itemInfo = this.sceneList[_i2];
      item.init(this.menu);
      this.node.addChild(item.node);
      y -= 50;
      item.updateItem(_i2, y, itemInfo.name, itemInfo.url);
      this.itemList.push(item);
    } // get item list in order to check the loadScene condition


    var searchComp = this.searchBlock.getComponent('SearchBlock');
    searchComp.init(this.menu);
    searchComp.setItemList(this.sceneList);
  },
  getPositionInView: function getPositionInView(item) {
    // get item position in scrollview's node space
    var worldPos = item.parent.convertToWorldSpaceAR(item.position);
    var viewPos = this.scrollView.node.convertToNodeSpaceAR(worldPos);
    return viewPos;
  },
  update: function update(dt) {
    this.updateTimer += dt;

    if (this.updateTimer < this.updateInterval) {
      return; // we don't need to do the math every frame
    }

    this.updateTimer = 0;
    var items = this.itemList;
    var buffer = this.bufferZone;
    var isDown = this.node.y < this.lastContentPosY; // scrolling direction

    var curItemCount = this.itemList.length;
    var offset = 50 * curItemCount;

    for (var i = 0; i < curItemCount; ++i) {
      var item = items[i];
      var itemNode = item.node;
      var viewPos = this.getPositionInView(itemNode);

      if (isDown) {
        // if away from buffer zone and not reaching top of content
        if (viewPos.y < -buffer && itemNode.y + offset < 0) {
          var newIdx = item.index - curItemCount;
          var newInfo = this.sceneList[newIdx];
          item.updateItem(newIdx, itemNode.y + offset, newInfo.name, newInfo.url);
        }
      } else {
        // if away from buffer zone and not reaching bottom of content
        if (viewPos.y > buffer && itemNode.y - offset > -this.node.height) {
          var _newIdx = item.index + curItemCount;

          var _newInfo = this.sceneList[_newIdx];
          item.updateItem(_newIdx, itemNode.y - offset, _newInfo.name, _newInfo.url);
        }
      }
    } // update lastContentPosY


    this.lastContentPosY = this.node.y;
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9zY3JpcHRzL0dsb2JhbC9TY2VuZUxpc3QuanMiXSwibmFtZXMiOlsiVGlwc01hbmFnZXIiLCJyZXF1aXJlIiwiU2NlbmVMaXN0IiwiY2MiLCJDbGFzcyIsIkNvbXBvbmVudCIsInByb3BlcnRpZXMiLCJpdGVtUHJlZmFiIiwidHlwZSIsIlByZWZhYiIsImluaXRJdGVtQ291bnQiLCJzY3JvbGxWaWV3IiwiU2Nyb2xsVmlldyIsImJ1ZmZlclpvbmUiLCJzZWFyY2hCbG9jayIsIk5vZGUiLCJjcmVhdGVJdGVtIiwieCIsInkiLCJuYW1lIiwidXJsIiwiaXRlbSIsImluc3RhbnRpYXRlIiwiaXRlbUNvbXAiLCJnZXRDb21wb25lbnQiLCJsYWJlbCIsInN0cmluZyIsIm5vZGUiLCJhZGRDaGlsZCIsImluaXQiLCJtZW51Iiwic2NlbmVMaXN0IiwiaXRlbUxpc3QiLCJ1cGRhdGVUaW1lciIsInVwZGF0ZUludGVydmFsIiwibGFzdENvbnRlbnRQb3NZIiwiaW5pdExpc3QiLCJzY2VuZXMiLCJnYW1lIiwiX3NjZW5lSW5mb3MiLCJkaWN0IiwiaSIsImxlbmd0aCIsInN0YXJ0c1dpdGgiLCJkaXJuYW1lIiwicGF0aCIsInJlcGxhY2UiLCJzY2VuZW5hbWUiLCJiYXNlbmFtZSIsImVycm9yIiwiZGlycyIsIk9iamVjdCIsImtleXMiLCJzb3J0IiwicHVzaCIsInNjZW5lbmFtZXMiLCJqIiwiaGVpZ2h0IiwiTWF0aCIsIm1pbiIsIml0ZW1JbmZvIiwidXBkYXRlSXRlbSIsInNlYXJjaENvbXAiLCJzZXRJdGVtTGlzdCIsImdldFBvc2l0aW9uSW5WaWV3Iiwid29ybGRQb3MiLCJwYXJlbnQiLCJjb252ZXJ0VG9Xb3JsZFNwYWNlQVIiLCJwb3NpdGlvbiIsInZpZXdQb3MiLCJjb252ZXJ0VG9Ob2RlU3BhY2VBUiIsInVwZGF0ZSIsImR0IiwiaXRlbXMiLCJidWZmZXIiLCJpc0Rvd24iLCJjdXJJdGVtQ291bnQiLCJvZmZzZXQiLCJpdGVtTm9kZSIsIm5ld0lk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LElBQUlLLE9BQU8sR0FBRyxLQUFLbEQsU0FBTCxDQUFlZ0QsTUFBZixDQUFkO1VBQ0ExRCxJQUFJLENBQUN3QyxVQUFMLENBQWdCa0IsTUFBaEIsRUFBd0JELFFBQVEsQ0FBQzVELENBQVQsR0FBYTJELE1BQXJDLEVBQTZDSSxPQUFPLENBQUM5RCxJQUFyRCxFQUEyRDhELE9BQU8sQ0FBQzdELEdBQW5FO1FBQ0g7TUFDSixDQVBELE1BT087UUFDSDtRQUNBLElBQUlpRCxPQUFPLENBQUNuRCxDQUFSLEdBQVl3RCxNQUFaLElBQXNCSSxRQUFRLENBQUM1RCxDQUFULEdBQWEyRCxNQUFiLEdBQXNCLENBQUMsS0FBS2xELElBQUwsQ0FBVThCLE1BQTNELEVBQW1FO1VBQy9ELElBQUlzQixPQUFNLEdBQUcxRCxJQUFJLENBQUMyRCxLQUFMLEdBQWFKLFlBQTFCOztVQUNBLElBQUlLLFFBQU8sR0FBRyxLQUFLbEQsU0FBTCxDQUFlZ0QsT0FBZixDQUFkO1VBQ0ExRCxJQUFJLENBQUN3QyxVQUFMLENBQWdCa0IsT0FBaEIsRUFBd0JELFFBQVEsQ0FBQzVELENBQVQsR0FBYTJELE1BQXJDLEVBQTZDSSxRQUFPLENBQUM5RCxJQUFyRCxFQUEyRDhELFFBQU8sQ0FBQzdELEdBQW5FO1FBQ0g7TUFDSjtJQUNKLENBOUJPLENBK0JSOzs7SUFDQSxLQUFLZSxlQUFMLEdBQXVCLEtBQUtSLElBQUwsQ0FBVVQsQ0FBakM7RUFDSDtBQTVJc0IsQ0FBVCxDQUFsQiIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgVGlwc01hbmFnZXIgPSByZXF1aXJlKCdUaXBzTWFuYWdlcicpO1xuXG5jb25zdCBTY2VuZUxpc3QgPSBjYy5DbGFzcyh7XG4gICAgZXh0ZW5kczogY2MuQ29tcG9uZW50LFxuXG4gICAgcHJvcGVydGllczoge1xuICAgICAgICBpdGVtUHJlZmFiOiB7XG4gICAgICAgICAgICBkZWZhdWx0OiBudWxsLFxuICAgICAgICAgICAgdHlwZTogY2MuUHJlZmFiXG4gICAgICAgIH0sXG4gICAgICAgIGluaXRJdGVtQ291bnQ6IDAsXG4gICAgICAgIHNjcm9sbFZpZXc6IGNjLlNjcm9sbFZpZXcsXG4gICAgICAgIGJ1ZmZlclpvbmU6IDAsIC8vIHdoZW4gaXRlbSBpcyBhd2F5IGZyb20gYnVmZmVyWm9uZSwgd2UgcmVsb2NhdGUgaXRcbiAgICAgICAgc2VhcmNoQmxvY2s6IGNjLk5vZGVcbiAgICB9LFxuXG4gICAgY3JlYXRlSXRlbTogZnVuY3Rpb24gKHgsIHksIG5hbWUsIHVybCkge1xuICAgICAgICB2YXIgaXRlbSA9IGNjLmluc3RhbnRpYXRlKHRoaXMuaXRlbVByZWZhYik7XG4gICAgICAgIHZhciBpdGVtQ29tcCA9IGl0ZW0uZ2V0Q29tcG9uZW50KCdMaXN0SXRlbScpO1xuICAgICAgICB2YXIgbGFiZWwgPSBpdGVtQ29tcC5sYWJlbDtcbiAgICAgICAgbGFiZWwuc3RyaW5nID0gbmFtZTtcblxuICAgICAgICBpZiAodXJsKSB7XG4gICAgICAgICAgICBpdGVtQ29tcC51cmwgPSB1cmw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpdGVtLndpZHRoID0gdztcbiAgICAgICAgaXRlbS54ID0geDtcbiAgICAgICAgaXRlbS55ID0geTtcbiAgICAgICAgdGhpcy5ub2RlLmFkZENoaWxkKGl0ZW0pO1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9LFxuXG4gICAgaW5pdCAobWVudSkge1xuICAgICAgICB0aGlzLm1lbnUgPSBtZW51O1xuICAgICAgICB0aGlzLnNjZW5lTGlzdCA9IFtdO1xuICAgICAgICB0aGlzLml0ZW1MaXN0ID0gW107XG4gICAgICAgIHRoaXMudXBkYXRlVGltZXIgPSAwO1xuICAgICAgICB0aGlzLnVwZGF0ZUludGVydmFsID0gMC4yO1xuICAgICAgICB0aGlzLmxhc3RDb250ZW50UG9zWSA9IDA7IC8vIHVzZSB0aGlzIHZhcmlhYmxlIHRvIGRldGVjdCBpZiB3ZSBhcmUgc2Nyb2xsaW5nIHVwIG9yIGRvd25cbiAgICAgICAgVGlwc01hbmFnZXIuaW5pdCgpO1xuICAgICAgICB0aGlzLmluaXRMaXN0KCk7XG4gICAgfSxcblxuICAgIC8vIHVzZSB0aGlzIGZvciBpbml0aWFsaXphdGlvblxuICAgIGluaXRMaXN0ICgpIHtcbiAgICAgICAgdmFyIHNjZW5lcyA9IGNjLmdhbWUuX3NjZW5lSW5mb3M7XG4gICAgICAgIHZhciBkaWN0ID0ge307XG5cbiAgICAgICAgaWYgKHNjZW5lcykge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2VuZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICBsZXQgdXJsID0gc2NlbmVzW2ldLnVybDtcbiAgICAgICAgICAgICAgICBpZiAoIXVybC5zdGFydHNXaXRoKCdkYjovL2Fzc2V0cy9jYXNlcy8nKSkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGRpcm5hbWUgPSBjYy5wYXRoLmRpcm5hbWUodXJsKS5yZXBsYWNlKCdkYjovL2Fzc2V0cy9jYXNlcy8nLCAnJyk7XG4gICAgICAgICAgICAgICAgbGV0IHNjZW5lbmFtZSA9IGNjLnBhdGguYmFzZW5hbWUodXJsLCAnLmZpcmUnKTtcblxuICAgICAgICAgICAgICAgIGlmICghZGlybmFtZSkgZGlybmFtZSA9ICdfcm9vdCc7XG4gICAgICAgICAgICAgICAgaWYgKCFkaWN0W2Rpcm5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpY3RbZGlybmFtZV0gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGljdFtkaXJuYW1lXVtzY2VuZW5hbWVdID0gdXJsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY2MuZXJyb3IoJ2ZhaWxlZCB0byBnZXQgc2NlbmUgbGlzdCEnKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBjb21waWxlIHNjZW5lIGRpY3QgdG8gYW4gYXJyYXlcbiAgICAgICAgbGV0IGRpcnMgPSBPYmplY3Qua2V5cyhkaWN0KTtcbiAgICAgICAgZGlycy5zb3J0KCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlycy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgdGhpcy5zY2VuZUxpc3QucHVzaCh7XG4gICAgICAgICAgICAgICAgbmFtZTogZGlyc1tpXSxcbiAgICAgICAgICAgICAgICB1cmw6IG51bGxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbGV0IHNjZW5lbmFtZXMgPSBPYmplY3Qua2V5cyhkaWN0W2RpcnNbaV1dKTtcbiAgICAgICAgICAgIHNjZW5lbmFtZXMuc29ydCgpO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzY2VuZW5hbWVzLmxlbmd0aDsgKytqKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBzY2VuZW5hbWVzW2pdO1xuICAgICAgICAgICAgICAgIGxldCB1cmwgPSBkaWN0W2RpcnNbaV1dW25hbWVdO1xuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmVMaXN0LnB1c2goeyBuYW1lLCB1cmwgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHkgPSAwO1xuICAgICAgICB0aGlzLm5vZGUuaGVpZ2h0ID0gKHRoaXMuc2NlbmVMaXN0Lmxlbmd0aCArIDEpICogNTA7XG4gICAgICAgIGxldCBpbml0SXRlbUNvdW50ID0gTWF0aC5taW4odGhpcy5pbml0SXRlbUNvdW50LCB0aGlzLnNjZW5lTGlzdC5sZW5ndGgpO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluaXRJdGVtQ291bnQ7ICsraSkge1xuICAgICAgICAgICAgbGV0IGl0ZW0gPSBjYy5pbnN0YW50aWF0ZSh0aGlzLml0ZW1QcmVmYWIpLmdldENvbXBvbmVudCgnTGlzdEl0ZW0nKTtcbiAgICAgICAgICAgIGxldCBpdGVtSW5mbyA9IHRoaXMuc2NlbmVMaXN0W2ldO1xuICAgICAgICAgICAgaXRlbS5pbml0KHRoaXMubWVudSk7XG4gICAgICAgICAgICB0aGlzLm5vZGUuYWRkQ2hpbGQoaXRlbS5ub2RlKTtcbiAgICAgICAgICAgIHkgLT0gNTA7XG4gICAgICAgICAgICBpdGVtLnVwZGF0ZUl0ZW0gKGksIHksIGl0ZW1JbmZvLm5hbWUsIGl0ZW1JbmZvLnVybCk7XG4gICAgICAgICAgICB0aGlzLml0ZW1MaXN0LnB1c2goaXRlbSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBnZXQgaXRlbSBsaXN0IGluIG9yZGVyIHRvIGNoZWNrIHRoZSBsb2FkU2NlbmUgY29uZGl0aW9uXG4gICAgICAgIGxldCBzZWFyY2hDb21wID0gdGhpcy5zZWFyY2hCbG9jay5nZXRDb21wb25lbnQoJ1NlYXJjaEJsb2NrJyk7XG4gICAgICAgIHNlYXJjaENvbXAuaW5pdCh0aGlzLm1lbnUpO1xuICAgICAgICBzZWFyY2hDb21wLnNldEl0ZW1MaXN0KHRoaXMuc2NlbmVMaXN0KTtcbiAgICB9LFxuXG4gICAgZ2V0UG9zaXRpb25JblZpZXc6IGZ1bmN0aW9uIChpdGVtKSB7IC8vIGdldCBpdGVtIHBvc2l0aW9uIGluIHNjcm9sbHZpZXcncyBub2RlIHNwYWNlXG4gICAgICAgIGxldCB3b3JsZFBvcyA9IGl0ZW0ucGFyZW50LmNvbnZlcnRUb1dvcmxkU3BhY2VBUihpdGVtLnBvc2l0aW9uKTtcbiAgICAgICAgbGV0IHZpZXdQb3MgPSB0aGlzLnNjcm9sbFZpZXcubm9kZS5jb252ZXJ0VG9Ob2RlU3BhY2VBUih3b3JsZFBvcyk7XG4gICAgICAgIHJldHVybiB2aWV3UG9zO1xuICAgIH0sXG5cbiAgICB1cGRhdGUgKGR0KSB7XG4gICAgICAgIHRoaXMudXBkYXRlVGltZXIgKz0gZHQ7XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZVRpbWVyIDwgdGhpcy51cGRhdGVJbnRlcnZhbCkge1xuICAgICAgICAgICAgcmV0dXJuOyAvLyB3ZSBkb24ndCBuZWVkIHRvIGRvIHRoZSBtYXRoIGV2ZXJ5IGZyYW1lXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51cGRhdGVUaW1lciA9IDA7XG4gICAgICAgIGxldCBpdGVtcyA9IHRoaXMuaXRlbUxpc3Q7XG4gICAgICAgIGxldCBidWZmZXIgPSB0aGlzLmJ1ZmZlclpvbmU7XG4gICAgICAgIGxldCBpc0Rvd24gPSB0aGlzLm5vZGUueSA8IHRoaXMubGFzdENvbnRlbnRQb3NZOyAvLyBzY3JvbGxpbmcgZGlyZWN0aW9uXG4gICAgICAgIGxldCBjdXJJdGVtQ291bnQgPSB0aGlzLml0ZW1MaXN0Lmxlbmd0aDtcbiAgICAgICAgbGV0IG9mZnNldCA9IDUwICogY3VySXRlbUNvdW50O1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1ckl0ZW1Db3VudDsgKytpKSB7XG4gICAgICAgICAgICBsZXQgaXRlbSA9IGl0ZW1zW2ldO1xuICAgICAgICAgICAgbGV0IGl0ZW1Ob2RlID0gaXRlbS5ub2RlO1xuICAgICAgICAgICAgbGV0IHZpZXdQb3MgPSB0aGlzLmdldFBvc2l0aW9uSW5WaWV3KGl0ZW1Ob2RlKTtcbiAgICAgICAgICAgIGlmIChpc0Rvd24pIHtcbiAgICAgICAgICAgICAgICAvLyBpZiBhd2F5IGZyb20gYnVmZmVyIHpvbmUgYW5kIG5vdCByZWFjaGluZyB0b3Agb2YgY29udGVudFxuICAgICAgICAgICAgICAgIGlmICh2aWV3UG9zLnkgPCAtYnVmZmVyICYmIGl0ZW1Ob2RlLnkgKyBvZmZzZXQgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBuZXdJZHggPSBpdGVtLmluZGV4IC0gY3VySXRlbUNvdW50O1xuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3SW5mbyA9IHRoaXMuc2NlbmVMaXN0W25ld0lkeF07XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0udXBkYXRlSXRlbShuZXdJZHgsIGl0ZW1Ob2RlLnkgKyBvZmZzZXQsIG5ld0luZm8ubmFtZSwgbmV3SW5mby51cmwgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGlmIGF3YXkgZnJvbSBidWZmZXIgem9uZSBhbmQgbm90IHJlYWNoaW5nIGJvdHRvbSBvZiBjb250ZW50XG4gICAgICAgICAgICAgICAgaWYgKHZpZXdQb3MueSA+IGJ1ZmZlciAmJiBpdGVtTm9kZS55IC0gb2Zmc2V0ID4gLXRoaXMubm9kZS5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld0lkeCA9IGl0ZW0uaW5kZXggKyBjdXJJdGVtQ291bnQ7XG4gICAgICAgICAgICAgICAgICAgIGxldCBuZXdJbmZvID0gdGhpcy5zY2VuZUxpc3RbbmV3SWR4XTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS51cGRhdGVJdGVtKG5ld0lkeCwgaXRlbU5vZGUueSAtIG9mZnNldCwgbmV3SW5mby5uYW1lLCBuZXdJbmZvLnVybCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIHVwZGF0ZSBsYXN0Q29udGVudFBvc1lcbiAgICAgICAgdGhpcy5sYXN0Q29udGVudFBvc1kgPSB0aGlzLm5vZGUueTtcbiAgICB9LFxufSk7XG4iXX0=
{"version":3,"sources":["assets/cases/05_scripting/10_network/downloader-native/DownloaderCtrl.js"],"names":["cc","Class","Component","properties","label","Label","sprite","Sprite","imgUrl","txtUrl","tempImgUrl","audioUrl","_downloader","_imgTask","_txtTask","_audioTask","_storagePath","_inited","_downloading","onLoad","CC_JSB","string","jsb","Downloader","setOnFileTaskSuccess","onSucceed","bind","setOnTaskProgress","onProgress","setOnTaskError","onError","fileUtils","getWritablePath","createDirectory","_audioID","task","audioEngine","stop","requestURL","assetManager","loadRemote","storagePath","err","tex","spriteFrame","SpriteFrame","node","active","content","getStringFromFile","substr","clip","play","bytesReceived","totalBytesReceived","totalBytesExpected","errorCode","errorCodeInternal","errorStr","downloadImg","createDownloadFileTask","loadImg","error","console","log","downloadTxt","downloadAudio","onDisable"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        label: cc.Label,\n        sprite: cc.Sprite,\n        imgUrl: \"https://download.cocos.com/test-case/logo.png\",\n        txtUrl: \"https://download.cocos.com/test-case/LICENSE.md\",\n        tempImgUrl: \"https://www.cocos.com/wp-content/uploads/2018/03/%E9%BB%98%E8%AE%A4%E6%A0%87%E9%A2%98_%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BA%95%E9%83%A8%E4%BA%8C%E7%BB%B4%E7%A0%81_2018.03.08.png\",\n        audioUrl: \"https://download.cocos.com/test-case/ss.mp3\",\n        _downloader: null,\n        _imgTask: null,\n        _txtTask: null,\n        _audioTask: null,\n        _storagePath: \"\",\n        _inited: false,\n        _downloading: false\n    },\n\n\n    // use this for initialization\n    onLoad () {\n        if (!CC_JSB) {\n            this.label.string = 'Downloader is a NATIVE ONLY feature.';\n            return;\n        }\n\n        this._downloader = new jsb.Downloader();\n        this._downloader.setOnFileTaskSuccess(this.onSucceed.bind(this));\n        this._downloader.setOnTaskProgress(this.onProgress.bind(this));\n        this._downloader.setOnTaskError(this.onError.bind(this));\n        this._storagePath = jsb.fileUtils.getWritablePath() + '/example-cases/downloader/';\n        this._inited = jsb.fileUtils.createDirectory(this._storagePath);\n        if (!this._inited) {\n            this.label.string = 'Failed to create storage path, downloader won\\'t work correctly';\n        }\n        this._audioID = -1;\n    },\n\n    onSucceed (task) {\n        if (this._audioID !== -1) {\n            cc.audioEngine.stop(this._audioID);\n        }\n        switch (task.requestURL) {\n        case this.imgUrl:\n            cc.assetManager.loadRemote(task.storagePath, (err, tex) => {\n                this.sprite.spriteFrame = new cc.SpriteFrame(tex);\n                this.sprite.node.active = true;\n                this.label.node.active = false;\n            });\n            break;\n        case this.txtUrl:\n            let content = jsb.fileUtils.getStringFromFile(task.storagePath);\n            this.sprite.node.active = false;\n            this.label.node.active = true;\n            this.label.string = content.substr(0, 350);\n            break;\n        case this.audioUrl:\n            this.sprite.node.active = false;\n            this.label.node.active = true;\n            this.label.string = 'Audio Download Complete.';\n            cc.assetManager.loadRemote(task.storagePath, (err, clip) => {\n                this._audioID = cc.audioEngine.play(clip);\n            });\n        }\n        // download success\n        this._downloading = false;\n    },\n\n    onProgress (task, bytesReceived, totalBytesReceived, totalBytesExpected) {\n\n    },\n\n    onError (task, errorCode, errorCodeInternal, errorStr) {\n        this._downloading = false;\n        this.sprite.node.active = false;\n        this.label.node.active = true;\n        this.label.string = 'Failed to download file (' + task.requestURL + '): ' + errorStr + '(' + errorCode + ')';\n    },\n\n    downloadImg () {\n        if (!this.imgUrl || !this._inited || this._downloading) {\n            return;\n        }\n        this.sprite.node.active = false;\n        this.label.node.active = true;\n        this.label.string = 'Downloading image';\n        this._imgTask = this._downloader.createDownloadFileTask(this.imgUrl, this._storagePath + 'download1.png');\n        this._downloading = true;\n    },\n\n    loadImg () {\n        if (!this.tempImgUrl || !this._inited || this._downloading) {\n            return;\n        }\n\n        this._downloading = true;\n        this.label.string = 'Downloading image (mem)';\n        cc.assetManager.loadRemote(this.tempImgUrl, (error, tex) => {\n            this._downloading = false;\n            if (error) {\n                console.log(\"Load remote image failed: \" + error);\n            }\n            else {\n                this.sprite.spriteFrame = new cc.SpriteFrame(tex);\n                this.sprite.node.active = true;\n                this.label.node.active = false;\n                cc.audioEngine.stop(this._audioID);\n            }\n        });\n    },\n\n    downloadTxt () {\n        if (!this.txtUrl || !this._inited || this._downloading) {\n            return;\n        }\n        this.label.node.active = true;\n        this.sprite.node.active = false;\n        this.label.string = 'Downloading Text';\n        this._downloading = true;\n        this._txtTask = this._downloader.createDownloadFileTask(this.txtUrl, this._storagePath + 'imagine.txt');\n    },\n\n    downloadAudio () {\n        if (!this.audioUrl || !this._inited || this._downloading) {\n            return;\n        }\n        this.sprite.node.active = false;\n        this.label.node.active = true;\n        this.label.string = 'Downloading Audio';\n        if (this._audioID !== -1) {\n            cc.audioEngine.stop(this._audioID);\n        }\n        this._downloading = true;\n        this._audioTask = this._downloader.createDownloadFileTask(this.audioUrl, this._storagePath + 'audioTest.mp3');\n    },\n\n    onDisable () {\n        cc.audioEngine.stop(this._audioID);\n    }\n\n});\n"]}